<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Cadenzr</title>

    <script src="app/jquery-3.1.1.min.js"></script>
    <script src="app/vue.js"></script>
    <script src="app/vue-router.js"></script>

    <!--<link href="style.css" rel="stylesheet" type="text/css">-->



</head>
<body>

    <div id="app">
        
        <audio-player ref="player"></audio-player>
        
        <router-view></router-view>
    </div>

    <script>

        // Albums component: renders a list of all albums
        const Albums = Vue.component('albums', {
            template:
                `<ul>
                    <li v-for="album in albums">
                        <router-link :to="{ path: album.link }">
                            {{album.name}}
                        </router-link>
                    </li>
                </ul>`,
            data: function () {
                return {
                    albums: []
                }
            },
            mounted () {
                this.loadAlbums();
            },
            methods: {
              loadAlbums: function(){
                  self = this
                  $.getJSON( "./albums", function(data) {
                        self.albums = data;
                        self.albums.forEach(function(album) {
                            console.log(album.id);
                            album.link = "albums/" + album.id;
                        });
                  });
              }
            }
        });
        
        const AudioPlayer = Vue.component('audio-player', {
            template:
                `<div>
                    <button v-on:click="prev">Previous</button>
                    <audio ref="audioplayer" v-on:ended="next" controls>
                        <source :src="song_stream" type="audio/mpeg">
                        Your browser does not support the audio tag.
                    </audio>
                    <button v-on:click="next">Next</button>
                    <p>
                        <b>Now playing:</b> <span v-if="index >= 0">{{songs[index].name}}</span>
                    </p>
                </div>`,
            data: function () {
                return {
                    song_stream: "",
                    index: -1,
                    songs: [],
                }
            },
            mounted: function () {
                this.$watch('index', function () {
                    this.song_stream = this.songs[this.index].stream_location;
                    this.$refs.audioplayer.load()
                    this.$refs.audioplayer.play()
              })
            },
            methods: {
                play: function(songs, index) {
                    this.songs = songs;
                    this.index = index;
                },
                next: function() {
                    this.index = (this.index + 1) % this.songs.length;
                },
                prev: function() {
                    this.index = (((this.index - 1) % this.songs.length) + this.songs.length) % this.songs.length; // shitty module since JS doesn't like mod of negative numbers
                }
            }
        })


        const Album = Vue.component('album', {
            template:
                `<ul>
                    <li v-for="song in songs"><a v-on:click="play(song)">{{song.name}}</a></li>
                </ul>`,
            data: function () {
                return {
                    songs: []
                }
            },
            mounted () {
                this.loadSongs();
            },
            methods: {
              loadSongs: function(){
                  self = this
                  $.getJSON( "./albums/" + self.$route.params.id + "/songs", function(data) {
                      self.songs = data;
                      var count = 0;
                      self.songs.forEach(function(song) {
                          song.index = count;
                          count++;
                      })
                  });
              },
              play: function(song){
                  self = this;
                  console.log(song.stream_location);
                  //app.$refs.player.song_stream = song.stream_location;
                  app.$refs.player.play(self.songs, song.index);
              }
            }
        });

        const routes = [
          { path: '/', component: Albums },
          { path: '/albums', component: Albums },
          { path: '/albums/:id', component: Album }
        ]

        const router = new VueRouter({
          routes // short for routes: routes
        })

        var app = new Vue({
          router
        }).$mount('#app')
    </script>

</body>
</html>
